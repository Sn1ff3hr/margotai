<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src-elem 'self' https://cdnjs.cloudflare.com 'nonce-2726c7f26c'; style-src-attr 'unsafe-inline'; script-src 'self' 'nonce-2726c7f26c'; font-src 'self' https://cdnjs.cloudflare.com;" />
  <title>Las Tortillas de Sauces 3</title>
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
  <style nonce="2726c7f26c">
    :root{ --bg:#0e1118; --ink:#ffffff; --muted:#c6cbe3; --card:#161b29; --accent:#6f7dff; --accent-2:#1ea97a; --danger:#ff4d6d; --line:rgba(255,255,255,.18); --chip:#212840; --input:#0c1020; --shadow:0 14px 40px rgba(0,0,0,.35); --edge:16px; --ink-light:#0a0e1a; --muted-light:#4a5670; --card-light:#ffffff; --line-light:rgba(10,14,26,.12); --input-light:#ffffff; --shadow-light:0 12px 28px rgba(0,0,0,.08); }
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
body{background:var(--bg);color:var(--ink);transition:background .45s ease,color .25s ease}
html[data-theme="light"] body{color:var(--ink-light);background:linear-gradient(45deg,#ffecd2,#fcb69f,#a1c4fd,#c2e9fb);background-size:400% 400%;animation:lightTheme 15s ease infinite}
@keyframes lightTheme{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
*,*::before,*::after{transition:background-color .35s ease,color .35s ease,border-color .35s ease,box-shadow .35s ease}

.wrap{max-width:1100px;margin:0 auto;padding:16px}

header{position:relative;display:flex;justify-content:center;align-items:center;margin-bottom:12px;min-height:44px}
.brand{font-weight:800;letter-spacing:.3px;text-align:center;font-size:2rem}
.actions{position:fixed;right:20px;top:20px;display:flex;flex-direction:column;gap:6px;align-items:flex-end;z-index:1000}

.toggle{
  all:unset;cursor:pointer;background:transparent;border:1px solid var(--line);
  padding:8px 14px;border-radius:999px;font-size:16px;line-height:1;color:inherit;
}
html[data-theme="light"] .toggle{border-color:var(--line-light)}
.btn{
  all:unset;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
  padding:10px 14px;border-radius:999px;background:var(--accent);color:#fff;
  font-size:14px;font-weight:700;box-shadow:var(--shadow);line-height:1;
}
.btn.alt{background:var(--accent-2)}

/* Carousel */
.carousel{position:relative;margin-top:50px}
.track{display:flex;gap:16px;overflow-x:auto;scroll-snap-type:x mandatory;padding-bottom:8px}
.track::-webkit-scrollbar{height:8px}
.track::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25);border-radius:999px}
html[data-theme="light"] .track::-webkit-scrollbar-thumb{background:rgba(20,20,30,.2)}
.card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(0,0,0,.18));border:1px solid var(--line);border-radius:var(--edge);box-shadow:var(--shadow)}
html[data-theme="light"] .card{background:var(--card-light);border-color:var(--line-light);box-shadow:var(--shadow-light)}
.product{scroll-snap-align:start;flex:0 0 calc((100% - 32px)/3);min-width:260px;padding:14px;display:flex;flex-direction:column;gap:10px;align-items:center}
@media (min-width:1024px){.product{flex-basis:75%;min-width:75%}}
@media (max-width:900px){.product{flex-basis:calc((100% - 16px)/2)}}
@media (max-width:560px){.product{flex-basis:100%}}
.product-image{width:100%;aspect-ratio:1/1;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.2rem;color:#ffffff;background:
  repeating-linear-gradient(135deg,#172043,#172043 12px,#0e132a 12px,#0e132a 24px)}
html[data-theme="light"] .product-image{color:#2b3766;background:repeating-linear-gradient(135deg,#eef2ff,#eef2ff 12px,#dae2ff 12px,#dae2ff 24px)}
.product-title{font-weight:700;font-size:1.4rem}
.product-desc{font-size:1.1rem;text-align:center}
.product-price{font-weight:800;color:#a9c6ff;font-size:1.3rem}
html[data-theme="light"] .product-price{color:#3344aa}
.qty{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.qty button{all:unset;cursor:pointer;padding:6px 12px;font-weight:800}
.qty input{all:unset;width:40px;text-align:center;padding:6px 4px}
.arrow{position:absolute;top:50%;transform:translateY(-50%);z-index:2}
.arrow button{all:unset;cursor:pointer;background:var(--chip);border:1px solid var(--line);width:42px;height:42px;border-radius:999px;display:grid;place-items:center;font-weight:900;color:#fff}
.arrow.left{left:-6px} .arrow.right{right:-6px}
html[data-theme="light"] .arrow button{background:#eef1fb;border-color:var(--line-light);color:#0a0e1a}

.panel{padding:14px;margin-top:10px}
.panel.deliver{width:75%;margin:0 auto}
@media (max-width:900px){.panel.deliver{width:100%}}
.delivery-text{text-align:center;font-weight:800;font-size:calc(1.4rem + 5px)}
.row{display:flex;gap:10px;align-items:center}
.row.wrap{flex-wrap:wrap;justify-content:space-between}
.muted{color:var(--muted)} html[data-theme="light"] .muted{color:var(--muted-light)}
.hr{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);margin:12px 0}
html[data-theme="light"] .hr{background:linear-gradient(90deg,transparent,var(--line-light),transparent)}
#delTimes{margin-top:10px}

/* Chips (delivery times) */
.chip{all:unset;cursor:pointer;background:rgba(255,255,255,.08);border:1px solid var(--line);padding:6px 10px;border-radius:999px;margin-right:6px}
.chip.sel{background:var(--accent-2);color:#fff;border-color:transparent}

/* Accordion */
.accordion{overflow:hidden;border-radius:12px;border:1px solid var(--line);margin-top:8px}
.acc-head{display:flex;justify-content:center;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;background:rgba(255,255,255,.06)}
.acc-head .chev{display:inline-block;transition:transform .25s}
.acc-head.open .chev{transform:rotate(180deg)}
.acc-body{max-height:0;overflow:hidden;transition:max-height .35s ease}
.acc-inner{padding:12px}
.acc-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:800px){.acc-grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:520px){.acc-grid{grid-template-columns:1fr}}
.ph{height:120px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#cfe0ff;background:
  repeating-linear-gradient(135deg,#1b2244,#1b2244 12px,#0e132a 12px,#0e132a 24px)}

/* Bottom split: KPIs left, totals right */
.split{display:grid;grid-template-columns:3fr 1fr;gap:16px}
@media (max-width:960px){.split{grid-template-columns:1fr}}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
@media (max-width:960px){.kpis{grid-template-columns:1fr}}
.kpi{padding:16px;text-align:center}
.kpi h4{margin:6px 0 8px 0}
.semicircle{
  width:100%;aspect-ratio:2/1;border-top-left-radius:2000px;border-top-right-radius:2000px;overflow:hidden;
  background:conic-gradient(var(--accent-2) var(--val,0%), #394155 var(--val,0%));
  transform:rotate(180deg)
}
.semicircle > .cover{
  position:relative;inset:auto;width:100%;height:100%;display:grid;place-items:center;transform:rotate(180deg)
}
#kpi1 .semicircle{
  background:conic-gradient(var(--accent-2) var(--val,0%), #ffd700 var(--val,0%));
}
.score{font-size:28px;font-weight:800}
.sub{font-size:.85rem;opacity:.8}
.smiley{font-size:60px;margin-bottom:8px}
.stars{display:flex;justify-content:center;gap:4px;color:#ffd700;font-size:24px}
.stars i{cursor:pointer}
.bar-chart{display:flex;align-items:flex-end;gap:8px;height:120px;margin-top:10px}
.bar-chart .bar{flex:1;background:var(--accent);position:relative;border-radius:4px;height:calc(var(--val)*1%)}
.bar-chart .bar span{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:.8rem}
.line-chart{margin-top:10px}
.line-chart svg{width:100%;height:120px}
.line-chart .labels{display:flex;justify-content:space-between;font-size:.8rem;margin-top:4px;width:100%}

.totals{padding:16px}
.totals .line{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
.totals strong{font-weight:800}
.fab{position:fixed;right:20px;bottom:20px;display:flex;flex-direction:column;gap:10px;z-index:1000}
.fab a,.fab button{border-radius:60px;padding:12px 20px;font-size:16px;font-weight:700;line-height:1;box-shadow:0 4px 10px rgba(0,0,0,.3)}
.fab a{background:#25D366;color:#fff;text-decoration:none}

/* Modal + inputs */
dialog{border:none;border-radius:16px;max-width:760px;width:96%;padding:0;background:transparent}
dialog::backdrop{background:rgba(0,0,0,.6)}
.modal{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
html[data-theme="dark"] .modal{background:#0b0f16;border-color:rgba(255,255,255,.28);color:#ffffff}
html[data-theme="light"] .modal{background:#fff;border-color:var(--line-light);box-shadow:var(--shadow-light)}
.modal header,.modal footer{padding:12px 14px}
.modal header{position:relative;display:flex;justify-content:center;align-items:center;border-bottom:1px solid var(--line)}
.modal main{padding:14px;display:grid;gap:14px}
.modal header .close{position:absolute;right:14px;top:50%;transform:translateY(-50%);all:unset;cursor:pointer;font-weight:800;font-size:24px;line-height:1;padding:0 8px}
.right{display:flex;justify-content:flex-end;gap:8px}
/* center form fields */
.fields{display:grid;grid-template-columns:1fr 1fr;gap:12px;justify-content:center;margin:0 auto;max-width:500px}
.fields.full{grid-template-columns:1fr auto;justify-content:center;max-width:500px}
@media (max-width:640px){.fields,.fields.full{grid-template-columns:1fr}}
input,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:var(--input);color:var(--ink);caret-color:#fff}
input::placeholder,textarea::placeholder{color:rgba(255,255,255,.92)}
html[data-theme="light"] input,html[data-theme="light"] textarea{background:var(--input-light);border-color:var(--line-light);color:var(--ink-light)}
html[data-theme="light"] input::placeholder,html[data-theme="light"] textarea::placeholder{color:rgba(10,14,26,.6)}
.items{display:grid;gap:10px;justify-items:center;text-align:center}
.item-row{display:grid;grid-template-columns:auto auto;gap:8px;align-items:center;justify-content:center;font-size:calc(1rem + 5px)}
.inline-qty{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.inline-qty button{all:unset;cursor:pointer;padding:6px 10px;font-weight:800}
.inline-qty span{display:inline-block;min-width:28px;text-align:center}

.row.order-summary{justify-content:center;gap:20px;font-size:calc(1rem + 5px)}
.center-text{text-align:center}

/* High-contrast dark */
html[data-theme="dark"] .muted, html[data-theme="dark"] .panel *{color:#fff}
html[data-theme="dark"] input,html[data-theme="dark"] textarea{color:#fff;border-color:rgba(255,255,255,.28)}
  </style>
</head>
<body>
<div class="wrap">
<header>
<div class="brand" data-en="Las Tortillas de Sauces 3" data-es="Las Tortillas de Sauces 3">Las Tortillas de Sauces 3</div>
<div class="actions">
<button id="langBtn" class="toggle" aria-label="Toggle Language">ES</button>
<button id="themeBtn" class="toggle" aria-label="Toggle Theme">Dark</button>
</div>
</header>
<!-- PRODUCT CAROUSEL -->
<section class="carousel">
  <div class="arrow left"><button id="prev" aria-label="Previous">‹</button></div>
  <div class="arrow right"><button id="next" aria-label="Next">›</button></div>
  <div id="track" class="track" aria-live="polite"></div>
</section>

<!-- DELIVERY NOTICE + ACCORDION -->
<section class="panel card deliver">
  <div class="delivery-text"
       data-en="We deliver only: Sauces, Alborada, Guayacanes, Tarazana Brisas del Rio"
       data-es="Entregamos en: Saucés, Alborada, Guayacanes, Tarazana Brisas del Rio">
    We deliver only: Sauces, Alborada, Guayacanes, Tarazana Brisas del Rio
  </div>

  <div id="zoneAcc" class="accordion">
    <div class="acc-head" role="button" aria-expanded="false">
      <i class="fas fa-bars"></i>
      <span data-en="Our Menu" data-es="Nuestro Menú">Our Menu</span>
      <i class="fas fa-angle-double-down chev"></i>
    </div>
    <div class="acc-body">
      <div class="acc-inner">
        <div class="acc-grid">
          <div class="ph">Photo A</div>
          <div class="ph">Photo B</div>
          <div class="ph">Photo C</div>
        </div>
        <div class="hr"></div>
        <div class="muted" data-en="Add any description or conditions here."
             data-es="Agregue aquí cualquier descripción o condición.">Add any description or conditions here.</div>
      </div>
    </div>
  </div>
</section>

<!-- BOTTOM SPLIT: KPIs LEFT + TOTALS RIGHT -->
<section class="split">
  <!-- KPIs -->
  <div class="kpis">
    <div class="card kpi" id="kpi1">
      <h4 data-en="Customer Satisfaction" data-es="Satisfacción del cliente">Customer Satisfaction</h4>
      <div id="csSmiley" class="smiley fas fa-meh" aria-hidden="true"></div>
      <div id="csStars" class="stars">
        <i class="far fa-star"></i>
        <i class="far fa-star"></i>
        <i class="far fa-star"></i>
        <i class="far fa-star"></i>
        <i class="far fa-star"></i>
      </div>
      <div class="muted" style="margin-top:8px" data-en="Keep delighting guests." data-es="Sigue encantando a los clientes.">Keep delighting guests.</div>
    </div>

    <div class="card kpi" id="kpi2">
      <h4 data-en="Visits" data-es="Visitas">Visits</h4>
      <div class="bar-chart">
        <div class="bar" style="--val:30">
          <span data-en="Today" data-es="Hoy">Today</span>
        </div>
        <div class="bar" style="--val:60">
          <span data-en="3 months ago" data-es="Hace 3 meses">3 months ago</span>
        </div>
        <div class="bar" style="--val:90">
          <span data-en="Last year" data-es="Año pasado">Last year</span>
        </div>
      </div>
    </div>

    <div class="card kpi" id="kpi3">
      <h4 data-en="Online Sales" data-es="Ventas en línea">Online Sales</h4>
      <div class="line-chart">
        <svg viewBox="0 0 100 60">
          <polyline points="0,50 50,30 100,10" fill="none" stroke="var(--accent-2)" stroke-width="4" stroke-linecap="round"/>
        </svg>
        <div class="labels">
          <span data-en="Today" data-es="Hoy">Today</span>
          <span data-en="3 months ago" data-es="Hace 3 meses">3 months ago</span>
          <span data-en="Last year" data-es="Año pasado">Last year</span>
        </div>
      </div>
    </div>
  </div>

  <!-- TOTALS -->
  <div class="card totals">
    <div class="line"><span class="muted" data-en="Subtotal" data-es="Subtotal">Subtotal</span><strong id="t_sub">$0.00</strong></div>
    <div class="line"><span class="muted" data-en="VAT 15%" data-es="IVA 15%">VAT 15%</span><strong id="t_tax">$0.00</strong></div>
    <div class="line"><span class="muted" data-en="Delivery 3.00" data-es="Entrega 3.00">Delivery 3.00</span><strong id="t_del">$0.00</strong></div>
    <div class="line"><span class="muted" data-en="Total" data-es="Total">Total</span><strong id="t_total">$0.00</strong></div>

    <div class="hr"></div>
    <div class="row" style="justify-content:flex-end">
      <button id="clearBtn" class="toggle" data-en="Clear Cart" data-es="Vaciar Carrito">Clear Cart</button>
    </div>

    <div class="hr"></div>
    <div class="muted" data-en="Delivery Time" data-es="Tiempo de entrega">Delivery Time</div>
    <div class="chips" id="delTimes" style="margin-top:10px">
      <button class="chip sel" data-min="45">45 min</button>
      <button class="chip" data-min="60">1 hr</button>
      <button class="chip" data-min="90">1 hr 30 min</button>
    </div>
  </div>
</section>

</div> <!-- FABs --> <div class="fab"> <a id="chatFab" href="https://wa.me/593993516952" target="_blank" rel="noopener noreferrer" data-en="💬 Chat" data-es="💬 Chat">💬 Chat</a> <button id="fabPay" class="btn alt" data-en="Pay" data-es="Pagar">Pay</button> </div> <!-- ORDER MODAL --> <dialog id="orderDlg"> <div class="modal"> <header> <div class="brand" data-en="Order Review" data-es="Revisión de Pedido">Order Review</div> <button class="close" id="closeDlg" aria-label="Close">×</button> </header> <main> <section> <div id="orderItems" class="items"></div> <div class="hr"></div> <div class="row order-summary"> <div class="muted" data-en="Delivery Time" data-es="Tiempo de entrega">Delivery Time</div> <strong id="m_deliveryTime">45 min</strong> </div> <div class="row order-summary"><div class="muted" data-en="Subtotal" data-es="Subtotal">Subtotal</div><strong id="m_sub">$0.00</strong></div> <div class="row order-summary"><div class="muted" data-en="VAT 15%" data-es="IVA 15%">VAT 15%</div><strong id="m_tax">$0.00</strong></div> <div class="row order-summary"><div class="muted" data-en="Delivery 3.00 (included)" data-es="Entrega 3.00 (incluida)">Delivery 3.00 (included)</div><strong id="m_del">$0.00</strong></div> <div class="row order-summary"><div class="muted" data-en="Total" data-es="Total">Total</div><strong id="m_total">$0.00</strong></div> </section>
    <div class="hr"></div>

    <section>
      <div class="muted center-text" data-en="Instructions" data-es="Instrucciones">Instructions</div>
      <textarea id="instructions" class="center-text" style="margin:0 auto; display:block;" rows="3" data-ph-en="No onions, leave at gate, etc." data-ph-es="Sin cebolla, dejar en la puerta, etc." placeholder="No onions, leave at gate, etc."></textarea>
    </section>

    <div class="hr"></div>

    <section>
      <div class="muted center-text" data-en="Customer Information" data-es="Información del Cliente">Información del Cliente</div>
      <div class="fields">
        <input id="firstName" required data-ph-en="Name" data-ph-es="Nombre" placeholder="Name" />
        <input id="lastName" required data-ph-en="Last name" data-ph-es="Apellido" placeholder="Last name" />
      </div>
      <div class="fields">
        <input id="idNumber" required data-ph-en="Céd / RUC" data-ph-es="Céd / RUC" placeholder="Céd / RUC" />
        <input id="phone" required data-ph-en="+593 9xx xxx xxx" data-ph-es="+593 9xx xxx xxx" placeholder="+593 9xx xxx xxx" inputmode="tel" />
      </div>
      <div class="fields" style="grid-template-columns:1fr;">
        <input id="email" required type="email" data-ph-en="Email" data-ph-es="Correo electrónico" placeholder="Email" />
      </div>
      <div class="fields full">
        <input id="address" required style="min-width:0" data-ph-en="Address" data-ph-es="Dirección" placeholder="Address" />
        <button id="locBtn" class="toggle" data-en="Use my location" data-es="Usar mi ubicación">Use my location</button>
      </div>
      <div id="gpsNote" class="muted" style="font-size:.9rem"></div>
    </section>
  </main>
  <footer class="right">
    <button class="toggle" id="cancelBtn" data-en="Cancel" data-es="Cancelar">Cancel</button>
    <button class="btn alt" id="confirmBtn" data-en="Pay" data-es="Pagar">Pay</button>
  </footer>
</div>

</dialog>
<script nonce="2726c7f26c">
"use strict";
/* ======================== CONFIG ========================= */
const CLOUDFLARE_WORKER_URL = ""; // optional
const APPS_SCRIPT_URL = ""; // optional
const WHATSAPP_NUMBER = "593993516952";
const BUSINESS = { name: "Las Tortillas de Sauces 3", address: "Av. Principal y Calle A", city: "Guayaquil", contact: "+593 99 999 9999", logo_url: "" };
/* ======================== DATA ========================= */
const VAT = 0.15, DELIVERY_FEE = 3.00;
const PRODUCTS = [ { id:"p1", name_en:"Option 1", name_es:"Opción 1", price:3.20, desc_en:"Tortilla, Chorizo, Fried Egg, Drink", desc_es:"Tortilla, Chorizo, Huevo frito, Bebida" }, { id:"p2", name_en:"Option 2", name_es:"Opción 2", price:2.70, desc_en:"Tortilla, Chorizo, Drink", desc_es:"Tortilla, Chorizo, Bebida" }, { id:"p3", name_en:"Option 3", name_es:"Opción 3", price:2.70, desc_en:"Tortilla, Fried Egg, Drink", desc_es:"Tortilla, Huevo frito, Bebida" }, { id:"p4", name_en:"Option 4", name_es:"Opción 4", price:6.40, desc_en:"Tortilla, Chorizo, Fried Egg, Drink (Large)", desc_es:"Tortilla, Chorizo, Huevo frito, Bebida (Grande)" }, { id:"p5", name_en:"Option 5", name_es:"Opción 5", price:2.25, desc_en:"Tortilla, Drink", desc_es:"Tortilla, Bebida" } ];
/* ======================== STATE & HELPERS ========================= */
let lang = localStorage.getItem('lang') || 'en'; let theme = localStorage.getItem('theme') || 'dark'; const cart = new Map(); let deliveryMinutes = 45; let gps = { lat:null, lng:null }; const $ = sel => document.querySelector(sel); const track = $('#track'); const t = (en,es)=> lang==='en'?en:es; const fmt = n => '$'+Number(n||0).toFixed(2); function setPh(el){ const ph = el.getAttribute(lang==='en'?'data-ph-en':'data-ph-es'); if(ph!==null) el.setAttribute('placeholder', ph); }
/* ======================== OPS Error Register ========================= */
const ERROR_DEFINITIONS = {
  'MCB-UI-001': { msg_en:'Unable to set language. Please refresh and ensure local storage is enabled.', msg_es:'No se puede cambiar el idioma. Actualice y asegúrese de que el almacenamiento local esté habilitado.', troubleshoot:'Check localStorage and data attributes for language toggling.' },
  'MCB-UI-002': { msg_en:'Unable to change theme. Please try again.', msg_es:'No se puede cambiar el tema. Intente nuevamente.', troubleshoot:'Ensure CSS variables for dark/light themes are defined.' },
  'MCB-UI-003': { msg_en:'Carousel navigation problem. Try reloading the page.', msg_es:'Problema de navegación del carrusel. Intente recargar la página.', troubleshoot:'Verify that product elements are rendered before navigation.' },
  'MCB-PRD-001': { msg_en:'Product display failed. Some items may not be shown.', msg_es:'Error al mostrar los productos. Es posible que algunos artículos no se muestren.', troubleshoot:'Check the PRODUCTS array and rendering logic.' },
  'MCB-CART-001': { msg_en:'Invalid cart quantity or empty cart. Please add at least one item.', msg_es:'Cantidad de carrito inválida o carrito vacío. Por favor agregue al menos un artículo.', troubleshoot:'Ensure quantities are positive numbers when updating the cart.' },
  'MCB-CART-002': { msg_en:'Cart total calculation problem. Totals may be incorrect.', msg_es:'Problema en el cálculo del total. Los totales pueden ser incorrectos.', troubleshoot:'Verify VAT/delivery constants and numeric inputs.' },
  'MCB-CART-003': { msg_en:'Delivery time selection failed. Please select a delivery time again.', msg_es:'Error al seleccionar el tiempo de entrega. Por favor seleccione un tiempo nuevamente.', troubleshoot:'Check `.chip` dataset minutes and event binding.' },
  'MCB-CART-004': { msg_en:'Unable to clear cart. Please try again.', msg_es:'No se pudo vaciar el carrito. Intente nuevamente.', troubleshoot:'Verify that the cart Map object is properly initialised.' },
  'MCB-MOD-001': { msg_en:'Failed to render order review. Some items may be missing.', msg_es:'Error al mostrar la revisión del pedido. Es posible que falten artículos.', troubleshoot:'Ensure PRODUCTS/cart valid before opening modal.' },
  'MCB-MOD-002': { msg_en:'Error updating item quantity in modal.', msg_es:'Error al actualizar la cantidad en el modal.', troubleshoot:'Check modal quantity button listeners.' },
  'MCB-GEO-001': { msg_en:'Geolocation not supported on this device.', msg_es:'La geolocalización no está soportada en este dispositivo.', troubleshoot:'Use a modern browser that supports navigator.geolocation.' },
  'MCB-GEO-002': { msg_en:'Unable to fetch location. Please allow location access and try again.', msg_es:'No se pudo obtener la ubicación. Permita el acceso e intente nuevamente.', troubleshoot:'Ensure permission & stable network.' },
  'MCB-FORM-001': { msg_en:'Invalid form data. Fill all fields with valid information.', msg_es:'Datos del formulario inválidos. Complete todos los campos con información válida.', troubleshoot:'Validate required fields + email/phone formats.' },
  'MCB-NET-001': { msg_en:'Error sending order to backend. It may not be recorded.', msg_es:'Error al enviar el pedido al servidor. Puede no haberse registrado.', troubleshoot:'Check connectivity and backend URLs.' },
  'MCB-NET-002': { msg_en:'Unable to open WhatsApp to send your order.', msg_es:'No se pudo abrir WhatsApp para enviar su pedido.', troubleshoot:'Ensure WhatsApp Web accessible and pop-ups allowed.' },
  'MCB-SYS-001': { msg_en:'Unexpected system error occurred.', msg_es:'Ocurrió un error inesperado.', troubleshoot:'Check console and reload.' },
  'MCB-CSP-001': { msg_en:'A security policy blocked a required resource.', msg_es:'Una política de seguridad bloqueó un recurso necesario.', troubleshoot:'Verify style/script integrity and/or nonce; confirm CSP style-src/script-src allow the source.' }
};
function handleError(code, context){ const def = ERROR_DEFINITIONS[code]; console.warn('Error context:', code, context, def?.troubleshoot); const msg = def ? t(def.msg_en, def.msg_es) : t('Unexpected error','Error inesperado'); alert(`${code}: ${msg}`); }
/* ======================== RENDER PRODUCTS ========================= */
function renderProducts(){ try { track.innerHTML = ''; PRODUCTS.forEach(p=>{ const name = lang==='en' ? p.name_en : p.name_es; const desc = lang==='en' ? p.desc_en : p.desc_es; const el = document.createElement('article'); el.className = 'product card'; el.innerHTML = ` <div class="product-image">Product Image</div> <div class="product-title">${name}</div> <div class="product-desc">${desc}</div> <div class="product-price">${fmt(p.price)}</div> <div class="qty" aria-label="${t('Quantity','Cantidad')} ${name}"> <button type="button" aria-label="${t('Decrease','Disminuir')}">−</button> <input type="text" inputmode="numeric" value="${cart.get(p.id)||0}" aria-label="${t('Quantity','Cantidad')}" /> <button type="button" aria-label="${t('Increase','Aumentar')}">+</button> </div>`; const [minus,input,plus] = el.querySelectorAll('.qty>*'); plus.addEventListener('click', ()=>{ cart.set(p.id,(cart.get(p.id)||0)+1); input.value=cart.get(p.id); recalc(); }); minus.addEventListener('click',()=>{ cart.set(p.id,Math.max(0,(cart.get(p.id)||0)-1)); input.value=cart.get(p.id); recalc(); }); input.addEventListener('input', ()=>{ const raw = input.value.replace(/\D/g,''); const v = Math.max(0, Math.min(999, parseInt(raw) || 0)); if (isNaN(v)) { handleError('MCB-CART-001'); input.value = 0; cart.set(p.id,0); } else { cart.set(p.id,v); input.value=v; } recalc(); }); track.appendChild(el); }); } catch(e) { handleError('MCB-PRD-001', e); } }
/* ======================== TOTALS + RECALC ========================= */
function totals(){ try { let sub=0; PRODUCTS.forEach(p=> sub+= p.price*(cart.get(p.id)||0)); const tax=sub*VAT, del=sub>0?DELIVERY_FEE:0, total=sub+tax+del; return {sub,tax,del,total}; } catch(e){ handleError('MCB-CART-002', e); return {sub:0,tax:0,del:0,total:0}; } }
function recalc(){ const {sub,tax,del,total} = totals(); $('#t_sub').textContent = fmt(sub); $('#t_tax').textContent = fmt(tax); $('#t_del').textContent = fmt(del); $('#t_total').textContent = fmt(total); }
/* ======================== LANGUAGE & THEME ========================= */
function syncLang(){ try { document.querySelectorAll('[data-en]').forEach(el=>{ el.textContent = el.getAttribute(lang==='en' ? 'data-en' : 'data-es'); }); document.querySelectorAll('[data-ph-en],[data-ph-es]').forEach(setPh); $('#langBtn').textContent = lang==='en' ? 'ES' : 'EN'; renderProducts(); recalc(); $('#m_deliveryTime').previousElementSibling.textContent = t('Delivery Time','Tiempo de entrega'); } catch(e){ handleError('MCB-UI-001', e); } }
function syncTheme(){ try { document.documentElement.setAttribute('data-theme',theme); $('#themeBtn').textContent = theme==='light' ? t('Dark','Oscuro') : t('Light','Claro'); } catch(e){ handleError('MCB-UI-002', e); } }
function scrollByCards(d){ try { const c = track.querySelector('.product'); const dx = c ? (c.getBoundingClientRect().width + 16) : 300; track.scrollBy({left:d*dx, behavior:'smooth'}); } catch(e){ handleError('MCB-UI-003', e); } }
/* ======================== ACCORDION ========================= */
(function(){ const head = document.querySelector('#zoneAcc .acc-head'); const body = document.querySelector('#zoneAcc .acc-body'); head.addEventListener('click', ()=>{ const open = head.classList.toggle('open'); head.setAttribute('aria-expanded', open?'true':'false'); body.style.maxHeight = open ? body.scrollHeight + 'px' : '0px'; }); new ResizeObserver(()=>{ if(head.classList.contains('open')) body.style.maxHeight = body.scrollHeight + 'px'; }).observe(body); })();
/* ======================== MODAL ========================= */
function renderModal(){ try { const box = $('#orderItems'); box.innerHTML=''; PRODUCTS.forEach(p=>{ const q = cart.get(p.id) || 0; if(!q) return; const row=document.createElement('div'); row.className='item-row'; row.innerHTML=`<div><strong>${lang==='en'?p.name_en:p.name_es}</strong> <div class="muted" style="font-size:.9rem">${lang==='en'?p.desc_en:p.desc_es}</div></div> <div class="inline-qty" data-id="${p.id}"> <button aria-label="${t('Remove','Quitar')}">−</button><span>${q}</span> <button aria-label="${t('Add','Agregar')}">+</button></div>`; box.appendChild(row); }); box.addEventListener('click', modalQtyHandler, {once:true}); const {sub,tax,del,total} = totals(); $('#m_deliveryTime').textContent = (deliveryMinutes===45)?t('45 min','45 min'):(deliveryMinutes===60)?t('1 hr','1 hr'):t('1 hr 30 min','1 hr 30 min'); $('#m_sub').textContent = fmt(sub); $('#m_tax').textContent = fmt(tax); $('#m_del').textContent = fmt(del); $('#m_total').textContent = fmt(total); } catch(e){ handleError('MCB-MOD-001', e); } }
function modalQtyHandler(e){ try { const box = e.target.closest('.inline-qty'); if(!box) return; const id = box.dataset.id; const span = box.querySelector('span'); if(e.target.textContent==='＋' || e.target.textContent==='+'){ cart.set(id,(cart.get(id)||0)+1); } else if(e.target.textContent==='−' || e.target.textContent==='-'){ cart.set(id, Math.max(0,(cart.get(id)||0)-1)); } else return; span.textContent = cart.get(id) || 0; recalc(); renderModal(); } catch(err){ handleError('MCB-MOD-002', err); } }
/* ======================== INIT + EVENTS ========================= */
renderProducts(); recalc(); syncLang(); syncTheme(); $('#prev').addEventListener('click',()=>scrollByCards(-1)); $('#next').addEventListener('click',()=>scrollByCards(1)); $('#langBtn').addEventListener('click',()=>{ lang=(lang==='en'?'es':'en'); localStorage.setItem('lang',lang); syncLang(); }); $('#themeBtn').addEventListener('click',()=>{ theme=(theme==='dark'?'light':'dark'); localStorage.setItem('theme',theme); syncTheme(); }); $('#clearBtn').addEventListener('click', e=>{ try{ e.preventDefault(); cart.clear(); renderProducts(); recalc(); } catch(err){ handleError('MCB-CART-004', err); } }); $('#delTimes').addEventListener('click', e=>{ if(!e.target.classList.contains('chip')) return; [...document.querySelectorAll('#delTimes .chip')].forEach(c=>c.classList.remove('sel')); e.target.classList.add('sel'); deliveryMinutes = +e.target.dataset.min || 45; }); const openPay = ()=>{ renderModal(); $('#orderDlg').showModal(); }; $('#fabPay').addEventListener('click',openPay); $('#closeDlg').addEventListener('click',()=>$('#orderDlg').close()); $('#cancelBtn').addEventListener('click',()=>$('#orderDlg').close()); // Geolocation $('#locBtn').addEventListener('click', ()=>{ if(!navigator.geolocation){ handleError('MCB-GEO-001'); return; } navigator.geolocation.getCurrentPosition(pos=>{ gps.lat = pos.coords.latitude; gps.lng = pos.coords.longitude; $('#gpsNote').textContent = `GPS: ${gps.lat.toFixed(5)}, ${gps.lng.toFixed(5)}`; },()=>{ handleError('MCB-GEO-002'); },{enableHighAccuracy:true, timeout:8000}); }); // Submit: Backend + WhatsApp $('#confirmBtn').addEventListener('click', async ()=>{ const firstName=$('#firstName').value.trim(); const lastName =$('#lastName').value.trim(); const idNumber=$('#idNumber').value.trim(); const phone =$('#phone').value.trim(); const email =$('#email').value.trim(); const address =$('#address').value.trim(); const instructions=$('#instructions').value.trim(); const emailOK=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); const phoneOK=/^\+?593\d{9,10}$/.test(phone)||/^0\d{8,9}$/.test(phone); if(!firstName||!lastName||!idNumber||!phoneOK||!emailOK||!address){ handleError('MCB-FORM-001'); return; } const items = PRODUCTS.map(p=>({ id:p.id, name:(lang==='en'?p.name_en:p.name_es), desc:(lang==='en'?p.desc_en:p.desc_es), qty:(cart.get(p.id)||0), unit:p.price })).filter(i=>i.qty>0); if(!items.length){ handleError('MCB-CART-001'); return; } const {sub,tax,del,total} = totals(); const payload={ lang,timestamp:new Date().toISOString(),business:BUSINESS, customer:{firstName,lastName,idNumber,phone,email,address,gps,city:""}, delivery:{minutes:deliveryMinutes,fee:DELIVERY_FEE,included:true,display:(deliveryMinutes===45)?t('45 min','45 min'):(deliveryMinutes===60)?t('1 hr','1 hr'):t('1 hr 30 min','1 hr 30 min')}, cart:{items,subtotal:sub,vat:tax,delivery:del,total,instructions} }; try{ if(CLOUDFLARE_WORKER_URL){ await fetch(CLOUDFLARE_WORKER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...payload,apps_script_url:APPS_SCRIPT_URL})}); }else if(APPS_SCRIPT_URL){ await fetch(APPS_SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}); } }catch(e){ handleError('MCB-NET-001', e); } const maps=(gps.lat&&gps.lng)?`\nMaps: https://maps.google.com/?q=${gps.lat},${gps.lng}`:""; const lines=items.map(i=>`• ${i.name} x${i.qty} = ${fmt(i.qty*i.unit)}`).join("\n"); const msg=`${t('Order','Pedido')} – ${BUSINESS.name}\n\n${t('Customer','Cliente')}: ${firstName} ${lastName}\nID: ${idNumber}\nTel: ${phone}\nEmail: ${email}\nDir: ${address}${maps}\n\n${t('Items Purchased','Artículos')}\n${lines}\n\n${t('Delivery Time','Tiempo de entrega')}: ${(deliveryMinutes===45)?t('45 min','45 min'):(deliveryMinutes===60)?t('1 hr','1 hr'):t('1 hr 30 min','1 hr 30 min')}\nSubtotal: ${fmt(sub)}\n${t('VAT 15%','IVA 15%')}: ${fmt(tax)}\n${t('Delivery','Entrega')}: ${fmt(del)}\n${t('Total','Total')}: ${fmt(total)}\n\n${t('Instructions','Instrucciones')}: ${instructions||'-'}`; try { const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`; window.open(url,'_blank'); } catch(err){ handleError('MCB-NET-002', err); } $('#orderDlg').close(); alert(t('Order sent. We also opened WhatsApp with the details.','Pedido enviado. También abrimos WhatsApp con los detalles.')); }); // Keyboard arrows for carousel document.addEventListener('keydown', e=>{ if(e.key==='ArrowLeft') scrollByCards(-1); if(e.key==='ArrowRight') scrollByCards(1); });

window.addEventListener('securitypolicyviolation', (e) => {
  const code = 'MCB-CSP-001';
  const detail = `CSP blocked: ${e.blockedURI || 'inline'} on ${e.violatedDirective}`;
  console.warn(code, detail, e);
  alert(`${code}: ${t('A security policy blocked a required resource.','Una política de seguridad bloqueó un recurso necesario.')}\n${t('Directive','Directiva')}: ${e.violatedDirective}\n${t('Blocked','Bloqueado')}: ${e.blockedURI || 'inline'}`);
});
</script>
<script nonce="2726c7f26c">
document.addEventListener('DOMContentLoaded', () => {
  const smiley = document.getElementById('csSmiley');
  const stars = Array.from(document.querySelectorAll('#csStars i'));
  const faces = ['fa-angry','fa-frown','fa-meh','fa-smile','fa-grin-stars'];
  function setRating(r){
    stars.forEach((s,i)=>{
      s.classList.toggle('fas', i < r);
      s.classList.toggle('far', i >= r);
    });
    smiley.className = 'smiley fas ' + faces[r-1];
  }
  stars.forEach((s,i)=> s.addEventListener('click', ()=> setRating(i+1)));
  setRating(3);
});
</script>
</body>
</html>
